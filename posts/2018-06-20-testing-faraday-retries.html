<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Ryan Butler - Testing Faraday retries with WebMock</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../">Ryan Butler</a>
            </div>
            <div id="navigation">
                <a href="../">Home</a>
                <a href="../about.html">About</a>
                <a href="../contact.html">Contact</a>
                <a href="../archive.html">Archive</a>
            </div>
        </div>

        <div id="content">
            <h1>Testing Faraday retries with WebMock</h1>

            <div class="info">
    Posted on June 20, 2018
    
</div>

<p>We use <a href="https://github.com/lostisland/faraday">Faraday</a> extensively for our making HTTP requests. We rely on <a href="https://github.com/bblimke/webmock">WebMock</a> to stub our these requests in rspec. We started encountering some timeout issues, and wanted to provide some retries without relying on a worker system. Fortunately, <strong>Faraday</strong> builds this in.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb1-1" data-line-number="1">connection = <span class="dt">Faraday</span>.new <span class="kw">do</span> |config|</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">  config.request <span class="st">:retry</span>, <span class="st">max: </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw">end</span></a></code></pre></div>
<p>Of course, I wanted to test this functionaltiy, which proved to be less than obvious. Fortunately, I discovered the <code>to_timeout</code> method stub. I was able to create the following two specs, which rely on the ability to chain methods in <strong>WebMock</strong> for subsequent calls.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb2-1" data-line-number="1">before <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">  <span class="kw">class</span> <span class="dt">Foo</span> </a>
<a class="sourceLine" id="cb2-3" data-line-number="3">    <span class="kw">def</span> <span class="dv">self</span>.root</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">      response = connection.get(<span class="st">&quot;/&quot;</span>)</a>
<a class="sourceLine" id="cb2-5" data-line-number="5">      response.status</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">    <span class="kw">end</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="kw">end</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9"></a>
<a class="sourceLine" id="cb2-10" data-line-number="10">context <span class="st">&quot;retries twice&quot;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-11" data-line-number="11">it <span class="st">&quot;succeeds after 2 timeouts&quot;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-12" data-line-number="12">  stub_request(<span class="st">:get</span>, stub_url)</a>
<a class="sourceLine" id="cb2-13" data-line-number="13">    .to_timeout</a>
<a class="sourceLine" id="cb2-14" data-line-number="14">    .to_timeout</a>
<a class="sourceLine" id="cb2-15" data-line-number="15">    .to_return(<span class="st">status: </span><span class="dv">200</span>)</a>
<a class="sourceLine" id="cb2-16" data-line-number="16"></a>
<a class="sourceLine" id="cb2-17" data-line-number="17">  expect {</a>
<a class="sourceLine" id="cb2-18" data-line-number="18">    <span class="dt">Foo</span>.new.root</a>
<a class="sourceLine" id="cb2-19" data-line-number="19">  }.not_to raise_error</a>
<a class="sourceLine" id="cb2-20" data-line-number="20"><span class="kw">end</span></a>
<a class="sourceLine" id="cb2-21" data-line-number="21"></a>
<a class="sourceLine" id="cb2-22" data-line-number="22">it <span class="st">&quot;fails after 3 timeouts&quot;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-23" data-line-number="23">  stub_request(<span class="st">:get</span>, stub_url)</a>
<a class="sourceLine" id="cb2-24" data-line-number="24">    .to_timeout</a>
<a class="sourceLine" id="cb2-25" data-line-number="25">    .to_timeout</a>
<a class="sourceLine" id="cb2-26" data-line-number="26">    .to_timeout</a>
<a class="sourceLine" id="cb2-27" data-line-number="27">    .to_return(<span class="st">status: </span><span class="dv">200</span>)</a>
<a class="sourceLine" id="cb2-28" data-line-number="28"></a>
<a class="sourceLine" id="cb2-29" data-line-number="29">  expect {</a>
<a class="sourceLine" id="cb2-30" data-line-number="30">    <span class="dt">Foo</span>.new.root</a>
<a class="sourceLine" id="cb2-31" data-line-number="31">  }.to raise_error</a>
<a class="sourceLine" id="cb2-32" data-line-number="32"><span class="kw">end</span></a></code></pre></div>
<p>It is nice to be able to test all aspects of our application, including configuration of a library.</p>

        </div>
        <div id="footer">
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </div>
    </body>
</html>
